<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="shortcut icon" href="assets/img/Logos/magisterLogo.svg" type="image/x-icon">
   <title>Magister </title>

   <!-- estilos -->
   <link rel="stylesheet" href="styles/login_cadastro.css">
   <link rel="stylesheet" href="styles/login_cadastro_mobile.css">
   

   <!-- Scripts-->
   <script src="scripts/login_cadastro.js"></script>

   <!-- Sweet alert-->
   <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
   

</head>
<body>
     <main class="main">

        <div class="login-section activeLogin " id="loginSection">

            <div class="form roxo">
                <a href="magister_index.html">
                    <div class="login-header">
                        <img src="assets/img/Logos/logoMagister.svg" alt="">
                        <h1>LOGIN</h1>
                    </div>
                </a>
                <div class="campo">

                    <label for="Email">Email:</label>
                    <div class="input-div">
                        
                        <input data-aos="fade-up" type="email" name="Email" id="email_input"
                            placeholder="exemplo@servidor.com"> 
                        
                        </input>

                        <br>
                        
                    </div>
                </div>

                <div class="campo">

                    <label for="Senha">Senha:</label>
                    <div class="input-div">
                        <img class="icon-input" >
                        <input type="password" id="senha_input">
                        <div onclick="senha()" style="cursor:pointer;">
                            <div id="olho_login" class="icon"> 
                        </div>
                        </div>
                    </div>
                </div>
                <button onclick="entrar()">Entrar</button>
                <h3 class="span-login active" id="txtLogin">Não tem conta ainda? <span id="closeLogin"> Cadastre-se </span></h3>



            </div>


        </div>

        <div class="cadastro-section close" id="cadastroSection">
            <h3>Já tem uma conta? <span id="activeLogin"> Entre </span></h3>

            <div class="form white">

                <div class="login-header">
                    <img src="assets/img/Logos/logoMagisterPreto.svg" alt="">
                    <h1>CADASTRO</h1>
                </div>

                <div class="campos-linha">

                    <div class="campo">

                        <label for="Nome">Nome:</label>
                        <div class="input-div">
                            <img class="icon-input" id="icon_nome_input"  alt="">
                            <input data-aos="fade-up" type="text" name="e-mail" id="nome_input_cadastro"
                                placeholder="Frizzarini" onblur="validar_nome_cadastro()">
                            
                            <span id="span_validar_nome">
                            </span>
                        </div>
                    </div>
                    <div class="campo">

                        <label for="Email">Email:</label>
                        <div class="input-div">
                            <img class="icon-input" id="icon_email_input" >
                            <input data-aos="fade-up" type="email" name="Email" id="email_input_cadastro"
                                placeholder="exemplo@servidor.com" onblur="validar_email_cadastro()">
                            
                            <span id="span_validar_email_cadastro">Por favor, insira um e-mail válido.</span>
                        </div>
                    </div>

                </div>

                <div class="campos-linha">

                    <div class="campo">

                        <label for="Senha">Senha:</label>
                        <div class="input-div">
                            
                            <img class="icon-input" id="icon_senha_input" >

                            <div style="cursor:pointer; position: relative;">
                            <input data-aos="fade-up" type="password" name="Senha" id="senha_input_cadastro"
                                placeholder="SenhaDaora12@" onblur="validar_senha_cadastro()">
                                <div id="olho" onclick="senha_cadastro()" class="icon_senha"></div>
                            </div>
                            
                            <span id="span_senha_cadastro">A senha deve possuir no mínimo 8 caracteres.</span>
                        </div>
                    </div>
                    <div class="campo">

                        <label for="ConfirmSenha">Confirmar Senha:</label>
                        <div class="input-div">
                            <img class="icon-input" id="icon_confirmar_senha_input" >
                            <div  style="cursor:pointer; position: relative;">
                                <input data-aos="fade-up" type="password" name="ConfirmSenha" id="conf_senha_input"
                                    placeholder="*************" onblur="validar_conf_senha_cadastro()">
                                    <div id="olho_confirmar" onclick="confirmar_senha_cadastro()" class="icon_confirmar"></div>
                                </div>
                            
                            <span id="span_validar_conf_senha">Ops! A senha inserida está incorreta. Por favor,
                                tente novamente</span>
                        </div>
                    </div>

                </div>

                <div class="campos-linha">
                    <div class="campo">
                        <label for="Codigo">Código da Instituição:</label>
                        <div class="input-div">
                            <img class="icon-input" id="icon_codigo_input" >
                            <input data-aos="fade-up" type="codigo" name="Codigo" id="codigo_input"
                                onblur="validar_codigo()" placeholder="sUU30fsG9mkW">
                    
                            <span id="span_validar_codigo">Códigos de intituição devem possuir pelo menos 6 caracteres.</span>
                        </div>
                    </div>
                </div>

                <button onclick="cadastrar()" class="btn-cadastrar">Cadastrar</button>

            </div>

        </div>

    </main>
</body>
</html>


<script src="scripts/trocaMod.js"></script>

<script>
    function entrar() {
    var emailVar = email_input.value;
    var senhaVar = senha_input.value;

    if (emailVar == "" || senhaVar == "") {
        swal("error","Preencha todos os campos","error");
    }
    else {
     
        fetch(`${window.location.origin}/usuarios/entrar/${emailVar}/${senhaVar}`, 
             {cache: "no-cache"}).then((informacoesUsuario) =>{
                if(informacoesUsuario.ok){
                    setInterval(4000);
                    swal('sucess','Redirecionando para dashboard','sucess')
                    informacoesUsuario.json().then(infosUser =>{
                        console.log(infosUser)
                        sessionStorage.emailUsuario = infosUser.email
                        sessionStorage.nomeUsuario = infosUser.nome
                        sessionStorage.idUsuario = infosUser.idUsuario
                        sessionStorage.nivPerm = infosUser.fkTipoUsuario
                        sessionStorage.instituicao = infosUser.fkInstituicao
                        
                        window.location = "dashboard/dashboard_geral.html"
                    })

                } else {
                    swal('warning','Email e/ou senha invalido!','error')

                    informacoesUsuario.text().then(texto => {
                        console.error(texto)
                    })

                }
             }).catch(function (erro) {
                console.log(erro);
            })
        return false
    }
}

// CADASTRO FUNCAO
function cadastrar() {
    var nomeVar = nome_input_cadastro.value;
    var emailVar = email_input_cadastro.value;
    var senhaVar = senha_input_cadastro.value;
    var codigoVar = codigo_input.value;

    if (nomeVar ==""||emailVar == "" || senhaVar == ""|| codigoVar =="") {
      
        swal("error","Preencha todos os campos","error");
        return false;
} 

fetch(`/instituicoes/buscarIdInst/${codigoVar}`, {
    cache: "no-cache"
}).then(idInst => {
    if(idInst.ok){
        idInst.json().then(idInst => {

            fetch("/usuarios/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nomeServer: nomeVar,
                    emailServer: emailVar,
                    senhaServer: senhaVar,
                    codigoServer: idInst[0].idInstituicao
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    toggleLogin()
                    swal("Parábens","Redirecionando para dashboard","sucess");
                    window.location = "login_cadastro.html"
                } else {
                    console.log("erro no cadastro")
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);

            });

            return false;
        }) 
    } else {
        swal("Error", "Código de instituição inválido!")
        return false;

    }
})

}

function validar_nome() {
    var input = document.getElementById('nomeInput');
    var nome = input.value;
    if (nome == "") {

        input.classList.remove('correto');
        input.classList.add('erro');
        input.placeholder = 'Campo vazio';
    }
    else if (nome.length < 3) {
        input.classList.remove('correto');
        input.classList.add('erro');
        input.placeholder = 'Nome muito curto';
    }
    else {
        input.classList.add('correto');
        input.placeholder = 'Nome';

    }
}


function validar_email() {
    var input = document.getElementById('emailInput');
    var email = input.value;

    if (email == '') {
        input.classList.remove('correto');
        input.classList.add('erro');
        input.placeholder = 'Campo vazio';
    }
    else if (email.indexOf("@") == -1 || email.indexOf(".com") == -1 || email.length < 7) {
        input.classList.remove('correto');
        input.classList.add('erro');
        input.placeholder = 'Email incorreto';
    }
    else {
        input.classList.add('correto');
        input.placeholder = 'Email';
    }
}


function validar_senha() {
    var input = document.getElementById('senhaInput');
    var senha = input.value;


    if (senha == "") {
        input.classList.remove('correto');
        input.classList.add('erro');
        input.placeholder = 'Campo vazio';
    }
    else if (senha.length < 8) {
        input.classList.remove('correto');
        input.classList.add('erro');
        input.placeholder = 'Senha menor que 8 caracteres';
    }
    else {
        input.classList.add('correto');
        input.placeholder = 'Senha';
    }
}

</script>